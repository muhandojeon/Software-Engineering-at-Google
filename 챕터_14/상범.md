# 챕터14 더 큰 테스트

사실 구글은 더 큰 테스트를 많이 활용하고 있다고 함

더 큰 테스트의 특성으로는 느릴 수 있고, 다른 테스트나 최종 사용자와 자원 및 트래픽을 공유하기도 하고, 비결정적일 수도 있다 인데, 이런 단점들에도 불구하고 더 큰 테스트를 이용하는 이유는 뭘까?

=> 단위 테스트는 함수, 객체, 모듈에 대한 확신을 심어주는 반면, 더 큰 테스트들은 시스템 '전체'가 의도대로 동작한다는 확신을 더해주는 역할을 함

=> 또 다른 존재 이유는 충실성을 높이기 위함임. 충실성이 높아질수록 비용이 커지고 테스트 실패 시에 손해가 크지만, 그대신 실제를 얼마나 잘 반영하는지를 측정 가능함 (엄청난 trade-off)

## 더 큰 테스트를 만들지 않는 이유

1. 소유권 문제

단위 테스트는 테스트가 검증하는 단위를 소유한 엔지니어와 팀이 테스트도 소유하는데 더 큰 테스트는 다수의 단위에 걸쳐있어서 관련된 소유자가 많음 => 시간이 흐를수록 소유권이 모호해지고 테스트는 서서히 부패됨

2. 표준화 부족

더 큰 테스트는 실행 방식이 너무 다양해서 표준화된 방식이 없음 => 자연스럽게 인프라의 지원을 받지 못함 => 신규 직원에게 단일한 테스트 방식을 가르칠 수 없음 => 영리하게 관리되지 못하여 고착됨

## 더 큰 테스트 @ 구글

수명과 상관 관계
- 단위 테스트는 기대 수명이 몇시간 이상만 되면 충분히 가치 있음
  - 테스트 대상은 로컬에서 실행됨
  - 특히 일회성 스크립트, 시연, 실험을 위한 경우라면 테스트 대상이 실행되는 로컬환경이 곧 프로덕션 환경
- 나머지 더 큰 테스트들은 프로덕션 인스턴스가 클라우드 호스팅 되는 경우가 많아서 테스트 대상이 테스트와 떨어지게 됨
  - 수명이 길어질수록 주 관심사가 테스트 유지보수로 옮겨감
 
오랫동안 코드를 건강하게 유지하려면 단위테스트와 수동테스트 사이의 간극을 매우는데 소홀해서는 안됨

구글은 코드 서브밋하려면 '반드시' 단위테스트 포함하도록 규정했다고 함

통합 테스트라 하더라도 가능한 작을수록 좋다~

## 큰 테스트의 구조

SUT: 테스트 대상 시스템

구글에는 다양한 형태의 SUT가 존재하고, 당연하지만 단위가 클수록 더 큰 테스트 됨

SUT, 데이터, 검증 방법들을 조합하면 다양한 형태의 큰 테스트를 만들수 있다~

e.g) SUT: 밀폐된 단일 머신 혹은 격리된 클라우드에 배포, 데이터: 수동 생성 혹은 프로덕션 환경에서 복사, 검증 방식: 단정문 혹은 차이 비교(성능 지표)

## 더 큰 테스트 유형

테스트 유형별로 어떤 위험을 완화해주는지 작성, 유지, 디버깅에 드는 노력은 어느정도인지 실행 비용 얼마나 되는지 등 특성이 달라진다~

구글에서 사용하는 큰 테스트의 종류
- 하나 이상의 바이너리에 대한 기능 테스트
- 브라우저와 기기 테스트
- 성능, 부하, 스트레스 테스트
- 배포 설정 테스트
- 탐색적 테스팅
- A/B 차이(회귀) 테스트
- 사용자 인수 테스트(User Acceptance Testing, UAT)
- 프로버와 카나리 분석
- 재해 복구와 카오스 엔지니어링
- 사용자 평가(dogfooding, 실험, 평가자 감정)

> Locust라는 오픈소스 툴을 사용하여 next.js v14 app router 환경에서 fetch revalidate 시간을 5분에서 1분으로 줄였을 때, 서버 인스턴스에 어떤 영향이 있을지에 대한 부하테스트를 해본 적이 있음    
> 실제 환경과 유사하게 테스트했을때 유의미한 테스트 결과가 나오지 않았었음. 어느 정도까지 호출하면 api에서 RateLimit이 발생한다던지의 그런 테스트를 할 때 유용하겠구나 생각하게 된 계기였음

