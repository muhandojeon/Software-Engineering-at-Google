# CHAPTER 17 Code Search

## 17.1 Code Search UI

Code Search UI의 핵심 요소는 **검색창**  
타이핑을 시작하면 제안 기능이 작동해 파일, 심볼, 디렉터리로 빠르게 찾아 들어갈 수 있다.  
Code Search는 Piper와도 통합되어 있어서 파일의 변경 이력도 볼 수 있다.

## 17.2 구글 개발자가 Code Search를 이용하는 방법

코드에 대한 답을 찾고 코드의 의도를 분명하게 이해하기 위해 Code Search를 이용한다.

- 결과에 랭킹을 매겨 보여줌
- 표현력 좋은 질의어를 제공해 구체적인 조건 적용 가능
- 검색 결과를 동료와 공유하기 쉬움
- 호출 계층을 브라우징하고 관련 파일 사이를 빠르게 오갈 수 있도록 해줌
- 특정 문제에 이용할 라이브러리를 찾은 다음, 그 안에서 가장 적합한 구현을 선택하도록 도와줌
- 특정 시점에서 코드베이스의 상태를 찾고 탐색할 수 있음
- 특정 코드가 언제 추가됐는지 볼 수 있고, 그 코드를 추가한 코드 리뷰로 점프 가능

## 17.3 독립된 웹 도구로 만든 이유

- 대규모 코드베이스 지원
- 설정 없이 모든 코드 볼 수 있음
- IDE가 아니기 때문에 편집보다 코드 탐색과 이해에 사용자 경험 최적화 가능했음
- 다른 도구에 통합
- API 제공해 개발자 생산성 향상

## 17.4 규모가 설계에 미치는 영향

코드 검색을 확장하는 데 가장 큰 걸림돌은 전체 코드의 크기  
중앙집중형 검색 솔루션은 이용자 수와 코드량이 늘면 함께 비대해짐  

### 검색 쿼리 지연시간

대체로 사람은 지연시간이 200ms보다 짧으면 UI가 빠르다고 느낀다.  
개발자의 생산성을 낮추지 않으려면 자주 쓰이는 기능은 백엔드에 충분히 투자해 종단간 지연시간을 200ms 미만으로 붙잡아둬야 한다.
Code Search UI에서는 여러 맥락 정보를 미리 정의해두고 필요 시 빠르게 바꿔가며 사용할 수 있다.

### 인덱싱 지연시간

개발자는 수정한 코드가 곧바로 인덱싱되기를 기대한다.  
하지만 구글 규모에서는 인덱스 생성에 몇 시간이 걸리고, 너무 복잡하여 인덱스를 하나의 버전만 유지한다.  
새 코드를 이전 인덱스에 연결해주는 패치를 일부 적용할 수는 있지만 여전히 해결해야 할 문제다.

> 이게 좀 치명적이네요

## 17.5 구글은 어떻게 구현했나?

### 검색 인덱스

**sparse n-gram 방식** 사용해서 grep보다 500배 이상 효율적이고, 정규 표현식 검색에도 빠르게 반응  

> 연속되지 않은 단어들의 조합을 고려하는 방식  
> 일반적인 n-gram이 문장에서 연속된 단어 시퀀스를 사용하는 반면, sparse n-gram은 중간에 단어를 건너뛰며 조합 생성 가능
> 
> 예시 문장: "The food was not very good"  
> - 일반 2-gram : `("The", "food"), ("food", "was")`처럼 연속된 경우만 가능
> - sparse 2-gram : `("The", "was"), ("not", "good")`처럼 중간에 단어 건너뛰기 가능

### 랭킹

검색 결과가 많은 경우에는 랭킹 기능이 중요함  
**랭킹을 매기려면 각 파일의 여러 특성(=시그널)을 점수로 환산할 함수가 필요함**  
점수가 높을수록 좋은 결과고, 점수 순으로 N개의 결과를 가능한 한 효율적으로 찾는 게 검색의 목표  
- 쿼리 독립적 시그널
  - 문서(파일)에만 의존적인 시그널
  - 파일 조회수와 파일로의 참조량을 뽑을 수 있음
  - 오프라인에서 계산할 수 있어서 계산량이 많아도 크게 문제되지 않음
- 쿼리 의존적 시그널
  - 검색 쿼리와 쿼리를 어떻게 문서에 매치시킬지에 의존하는 시그널
  - 쿼리마다 계산하는 방식이라서 계산량이 적어야 함 → 인덱스로부터 빠르게 얻을 수 있는 쿼리와 정보만 이용

문서에 점수를 매기기 전에 검색 쿼리와 일치할 가능성이 있는 후보를 찾는데, 이 단계를 검출이라고 함  
모든 문서를 다 검색하려면 비효율적이니까 검출된 문서들에만 점수를 매김  
원래의 쿼리를 다시 작성하여 더 전문화된 쿼리로 바꾸는 '보충 검출'이 효과 좋음

검색은 결과를 다양하게 보여줄 수 있어야 함  
ex. 간단한 함수 이름 검색 → 자바, 파이썬 결과 함께 제공  
사용자의 현재 작업 공간에서 가능성 높은 파일 이름과 정의를 조합해 추천 결과 목록 드롭다운 UI 제공하고 있음
