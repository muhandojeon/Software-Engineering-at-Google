# 챕터 22 대규모 변경

구글 경험에 따르면 코드베이스와 엔지니어 수가 늘어날수록 원자적으로 수행할 수 있는 변경의 크기는 줄어든다고 한다

우리의 코드베이스가 구글만큼 크지 않더라도 우리의 원칙을 잘 이해하고 수용한다면 우리 개발 조직을 확장하면서 코드베이스 전반을 유익하게 개선하는 데 무리 없을 것임

## 대규모 변경이란

- LSC(Large Scale Change): 대규모 변경

구글의 경우 LSC는 거의 항상 자동화 도구를 이용해 생성함

구글에서 수행하는 LSC의 대다수는 기능을 변경하지 않음, 주로 명확성, 최적화, 미래 호환성 개선이 목표임 

## 원자적 변경을 가로막는 요인

구글의 LSC 프로세스를 이야기하려면 왜 수많은 변경들이 원자적으로 커밋될 수 없는지를 이해해야 됨

### 유령의 묘지

- 유령의 묘지: 너무 오래되고 둔하고복잡해서 아무도 손대려 하지 않는 시스템

구글은 충실한 테스트가 유령의 묘지 퇴출에 아주 효과적임을 깨달았음. 변경해도 이상이 생기지 않으리라는 믿음이 생기니까

### 이질성

LSC가 가능하려면 작업 대부분을 사람이 아니라 컴퓨터가 처리해줘야 됨. 근데 사람과 달리 모호한 일을 컴퓨터가 잘 처리하지 못함

조직에서 CI 시스템을 운영하고 프로젝트별 도구와 스타일 가이드가 다르다면 코드베이스 전체를 아우르는 변경은 진행하기 어려움

반대로 환경을 단순화해 일관성을 높이면 인력을 재배치하기도 좋고 컴퓨터가 변경을 자동 수행하는데도 좋음

그래서 구글에선 변경사항을 코드베이스에 반영하기 전에 프리서브밋 검사 수행하도록 걸어놨음

근데 이 검사 중 많은 비중이 새로운 기능을 개발하는 팀을 위한 것이라서 LSC 때는 변경 내용과 관련없이 복잡성만 키우기도 한다고 함

하지만? 그럼에도 불구하고 구글은 프리서브밋 검사를 표준 프로세스에 녹임 => 일관성을 위해 복잡성을 수용한 사례. (+ LSC로 인한 테스트 떄는 팀 특화 검사를 생략하도록 조언하기도 함)

### 테스트 

모든 변경은 테스트 되어야 하지만 변경의 덩치가 커지면 제대로 테스트 하기 어려움

구글은 이럴 변경의 10~20%가 LSC 때문인 프로젝트가 흔함, 테스트 하는 일이 느린 경우가 많아서 속도를 높이기 위해 TAP 열차라는 테스트 자동화 플랫폼 전략을 활용함

## 대규모 변경 인프라

구글은 LSC를 가능케 하기 위해 인프라에 막대한 투자 했음

정책과 문화 차원에서 인프라팀을 신뢰하는 일이 LSC를 조직에 연착륙시키는 중요한 첫단추임

Rosie는 LSC를 구글 규모에서 진행할 수 있게 도와주는 플랫폼임, 광범위한 변경에 수반되는 수많은 변경을 독립적으로 테스트, 리뷰, 서브밋할 수 있는 작은 샤드들로 나눌 수 있음

## 대규모 변경 프로세스

1. 권한 부여
- LSC 작성자에게 아래 내용을 포함한 간단한 제안 문서 작성 요청함
  - 변경 제안 이유
  - 코드베이스 전반에 주는 예상 영향
  - 리뷰어들이 던질마한 질문과 그에 대한 답변 
2. 변경 생성
- 전역 변경 하나 생성
3. 샤드 관리
- Rosie를 실행하여 거대한 변경 하나 입력받아서 서브밋할 수 이는 작은 변경(샤드)들로 쪼갬
- 샤드별 테스트를 CI로 돌림(TAP 전략)
- 리뷰어에게 메일 보내기
- 리뷰 ㄱ ㄱ
- 서브밋하기
4. 마무리 청소
- 대규모 변경이 애써 제거한 심볼이나 시스템이 다시 사용되는 일을 막아주는 방책이 필요하고, Tricorder 프레임 워크를 이용하여 누가 폐기 대상 객체 사용하면 코드리뷰 때 알려줘서 변경을 역행하지 않게끔 막음


## 마치며

> 구글처럼 대규모 조직에선 대규모 변경을 어떻게 처리하는지, 처리하기 위한 도구들이 있는지, 어떠한 정책과 문화가 있는지에 대해 구글 엔지니어분이 커피챗하면서 알려주는 느낌으로 읽었고 딱 그정도 수준으로 이해했음
>
> 그리고 마지막에 LSC에 성공하려면 LSC를 습관처럼 진행해야 된다는 말에 공감했다. 코드베이스를 그냥 내버려두면 고치기가 점점 어려워져서 꾸준히 조금씩 개선해야 한다고 하며 글을 마쳤는데, 그렇다면 어떻게 꾸준히 조금씩 개선할 수 있을까?
>
> 나는 아무래도 데드라인을 센스껏 길게 잡고 중간 중간 리팩토링 작업 드가는게 가장 베스트인 것 같다..
