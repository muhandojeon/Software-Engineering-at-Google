# CHAPTER 22 대규모 변경

## 22.1 대규모 변경이란?

구글의 경우 대규모 변경(Large Scale Change, LSC)은 거의 항상 자동화 도구를 이용해 생성한다.  

LSC로 인해 생성되는 변경
- 코드베이스 전반을 훑는 분석 도구로 찾은 공통 안티패턴 청소
- 폐기 대상 API 호출 대체
- 저수준 인프라 개선
- 사용자들을 옛 시스템에서 새로운 시스템으로 마이그레이션

많은 팀이 LSC를 수월히 진행할 수 있도록 일찍부터 꾸준히 도구에 투자하는 것이 유리하다.

## 22.2 누가 대규모 변경을 처리하나?

구글에서는 LSC의 상당 비중을 인프라팀이 수행한다.  
사용자에게 새 버전을 쓰지 않도록 강제하는 이유는 아래와 같다.
- 시스템을 구축하는 인프라팀은 그 시스템을 활용하는 참조를 수정하는 데 필요한 도메인 지식 역시 갖추고 있다.
- 합당한 보상 없이 할 일만 늘어나는 상황을 좋아할 사람은 없다.
- 대규모로 변경해야 할 시스템을 소유한 팀이 주도해야 변경을 완료하는 데 유리하다.

## 22.3 원자적 변경을 가로막는 요인

### 기술적 한계

중앙집중형 VCS에서는 커밋 중에 다른 사용자가 쓰기 작업을 하지 못한다.  
다시 말해 거대한 커밋은 다른 사용자들의 일을 멈춰세운다.  
이처럼 주어진 인프라에 따라 거대한 변경을 원자적으로 처리하는 일이 애초에 불가능할 수 있다.  

### 병합 충돌

변경의 규모가 커질수록 자연스럽게 병합 시 충돌이 생길 가능성이 커진다.

### 유령의 묘지

유령의 묘지란 너무 오래되고 둔하고 복잡해서 아무도 손대려 하지 않는 시스템을 뜻한다.  
LSC의 관점에서 유령의 묘지는 진보를 가로막는다.  
충실한 테스트가 유령의 묘지 퇴출에 아주 효과적이다.

### 이질성

LSC가 가능하려면 사람이 아니라 컴퓨터가 처리해줘야 한다.  
컴퓨터가 변경 코드를 정확한 위치에 올바르게 반영하려면 환경이 일관되어야 한다.  
환경을 단순화해 일관성을 높이면 변경을 자동으로 수행하는 데도 좋다.

### 테스트

작고 독립적인 변경은 검증하기가 쉽지만, 변경의 덩치가 커지면 제대로 테스트하기 어렵다.

### 코드 리뷰

거대한 커밋을 검토하기란 지루하고 번거롭고 오류가 스며들기 쉽다.

## 22.4 대규모 변경 인프라

### 정책과 문화

제품팀이 인프라팀을 신뢰하는 일이 LSC를 조직에 연착륙시키는 중요한 첫 단추였다.

### 코드베이스 인사이트

LSC를 진행하려면 코드베이스 전반을 분석할 수 있어야 한다.  
어떤 도구로 변경을 생성하든 인력 투입량이 코드베이스보다 느리게 커져야 한다.

### 변경 관리

변경을 여러 개의 샤드로 나누고 테스트, 메일링, 리뷰, 커밋 단계를 독립적으로 관리해주는 도구가 필요하다.

### 테스트

마스터 변경이 문제를 일으키지 않음을 확인하는 일 외에, 개별 샤드를 안전하고 독립적으로 서브밋할 수 있는지까지 검증해야 한다.

### 언어 지원

언어에 따라 LSC 난이도가 다르며, 정적 타입 언어가 동적 타입 언어보다 유리하다.  
자동 포맷터 역시 LSC 인프라에서 중요한 역할을 담당하기에 LSC 생성 도구가 언어별 자동 포맷터까지 실행한다.

## 22.5 대규모 변경 프로세스

권한 부여 → 변경 생성 → 샤드 관리 → 마무리 청소
