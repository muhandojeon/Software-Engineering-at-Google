# 챕터 23 지속적 통합

CI의 목적은 문제를 일으키는 변경을 가능한 한 조기에 자동으로 발견해내는 것

'자주 통합한다' 라는 말은 코드 의존성에서 시야를 넓혀보면 운영체제, 런타임, 클라우드 호스팅 서비스, 디바이스 등 까지 옮겨 다닐 수 있다

우리는 이러한 주변 요소 모두를 의존성으로 간주해야 하며 이 의존성들의 변경까지 모두 '지속적으로 통합'하는 걸 목표로 삼아야 한다

그래서 요즘 현실을 반영하여 CI를 다시 정의하면, 지속적 통합은 '빠르게 진화하는 복잡한 생태계 전체를 지속적으로 조립하고 테스트하는 개발 방식'으로 정의할 수 있다

> CI를 코드뿐 아니라 모든 의존성까지 확장해 보는 시각이 새로웠다

또, CI와 테스트는 강하게 엮여 있음

## 지속적 통합의 빠른 피드백 루프

CI는 우리가 빠른 피드백 루프를 이용하도록 유도하여 버그 비용을 최소로 줄여줌

카나리 배포를 활용하면 프로덕션 전체에 배포하기 전에 일부에만 먼저 배포하여 초기 피드백 루프를 만들 수 있기 때문에 문제가 확실하게 줄어듦

실험과 기능 플래그도 매우 강력한 피드백 루프에 포함됨. 변경을 컴포넌트 단위로 격리한 후 프로덕션 환경에서 동적으로 켜고 끌 수 있게 하여 배포 위험을 줄여주는 기법들임

### 볼 수 있고 조치할 수 있는 피드백

테스트 리포트 시스템을 이용하여 빌드와 테스트 결과를 로그까지 누구든 쉽게 볼 수 있게 가능

### 자동화

보통 '빌드'와 '릴리즈' 프로세스를 자동화함

> 여기서 참 헤드(최신 변겨잉 커밋된 버전)와 녹색 헤드(지속적 빌드가 검증한 최신 변경) 라는 재밌는 단어가 나옴

#### 지속적 배포

릴리스 후보(RC)는 지속적 빌드를 통과한 코드에 설정 정보, 기타 의존성들을 조합해 만든다고 함

지속적 배포에는 지속해서 릴리스 후보를 조립하고 다양한 환경에 차례로 승격시켜 테스트 한다고 함. (프로덕션까지 승격시키는 경우도 있고 그렇지 않은 경우도 있다고 함)

RC가 운영 환경에서 단계별로 승격될 때 이상적으로는 아티팩트들을 다시 컴파일하거나 빌드하지 않아야 된다고 함 (비슷하게 쿠버네티스 같은 오케스트레이션 도구를 이용하면 배포 사이에 일관성을 유지하기가 더 유리함)

구글은 환경 간 릴리스와 배포를 일관되게 관리하여 초기 테스트부터 충실성을 끌어올림

### 프리서브밋만으로 부족한 이유

서브밋 직전에 자동화 테스트를 수행하여 문제가 있는 변경을 최대한 일찍 발견하면 좋을텐데 그럼에도 프리서브밋 때 모든 테스트를 다 돌려보지 않는 이유는 그만큼 테스트 기다려야해서 개발자 생산성이 매우 떨어져서 이다

### 프리서브밋 vs 포스트서브밋

그래서 프리서브밋 때는 빠르고 안정적인 테스트 위주로 수행시킨다

프리서브밋 때는 커버리지를 다소 포기하고 놓친 문제들을 포스트서브밋 때 잡아내는 전략을 가져간다 (문제가 있다면, 롤백 할 수 있음을 감안해야 됨) 어쩔 수 없이 포스트서브밋 때는 더 오래 걸리고 약간 불안정한 테스트를 포함시킴

구글의 팀 대부분은 프리서브밋 때 자기 팀의 (단위테스트 같은) 작은 테스트들을 실행 함 (가장 빠르고 가장 안정적이니까)

### CI의 과제

실패 관리 역시 만만치 않은 문제임. 여기서 실패 관리란 테스트 실패 시 어떻게 대응해야 하는가이다

거대한 종단간 테스트가 끼어들면 테스트 스위트를 녹색으로 유지하기가 극히 어려움 (본질적으로 꺠지기 쉽고 불규칙하고 디버그하기 어려움..)

이런 상황에, 구글은 대응 담당자나 릴리스 엔지니어가 제출하고 적절한 팀으로 분배되는 버그 핫리스트를 애용한다고 하네요

이러한 테스트 불안정성에 일반적으로 테스트를 여러번 시도하는 방식으로 대처할 수 있고 실제로 많은 팀에서 활용하는 방법임

#### 밀폐 테스트

밀폐 테스트: 모든 것을 갖춘 텥스트 환경에서 수행하는 테스트

예컨데 프로덕션 백엔드 등의 외부 의존성을 전혀 이용하지 않으며 테스트에 필요한 애플리케이션 서버나 자원 등을 모두 갖춘 환경에서 테스트하는 것을 말함

중요한 특징 두가지: 우수한 결정성(e.g 안정성)과 격리

밀폐된 서버들에도 시스템 시간, 무작위 숫자 생성, 스레드 간 경쟁 상태 등 비결정적 소지가 여전히 남아있음

그러나 테스트에 영향을 주는 데이터가 적어도 외부 의존성 때문에 바뀔 일은 없으므로 똑같은 애플리케이션과 테스트 코드로 두 번 테스트하면 같은 결과를 얻음

밀폐 테스트에 필요한 백엔드는 가짜서버로 대체 가능. 실제 백엔드보다 저렴하게 이용 가능. 하지만 유지보수가 필요해서 충실성 측면에서 한계가 있음

프리서브밋을 가치 있는 통합 테스트로 만들려면 필요한 전체 구성요소를 샌드박스에 담아 시작하는 완벽하게 밀폐된 설정을 활용하는 방법이 제일 깔끔하다고 함
