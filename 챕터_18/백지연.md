# CHAPTER 18 빌드 시스템과 빌드 철학

구글의 빌드 시스템은 구글 엔지니어에게 만족도가 엄청 높다.  
빌드 시스템의 핵심 요소인 Blaze는 퇴사한 직원들이 몇 차례나 다시 구현했을 정도고, 현재는 Bazel이라는 오픈소스로 공개되어 있다.

> https://github.com/bazelbuild/bazel

> [!IMPORTANT]
> 구글의 교훈 : 때로는 엔지니어의 힘과 유연성을 제한해야 생산성을 높일 수 있다.

## 18.1 빌드 시스템의 목적

빌드 시스템의 목적은 **엔지니어가 작성한 소스 코드를 기계가 읽을 수 있는 바이너리로 변환**하는 것이다.  
훌륭한 빌드 시스템은 **속도**와 **정확성**을 최적화한다.  

## 18.2 빌드 시스템이 없다면?

빌드 시스템은 더 큰 개발 프로젝트를 진행할 수 있게 해준다.  

- 1~2주 동안 몇백 줄 정도의 코드를 작성하는 프로젝트라면 **컴파일러**로 충분
- **셸 스크립트**를 이용하면 조금 더 프로젝트도 가능
- 여러 명의 개발자와 여러 머신이 동원되기 시작하면 제대로 된 **빌드 시스템**에 투입해야 한다.

## 18.3 모던 빌드 시스템

의존성을 관리하는 일이 빌드 시스템 구축에서 가장 기본이 되는 작업이다.

### 태스크 기반 빌드 시스템

엔지니어에게 자신의 태스크를 정의할 수 있게 하는 힘 부여  
ex. 셸 스크립트

#### 주요 단점 3가지

1. 빌드 단계들을 병렬로 실행하기 어렵다
2. 증분 빌드를 수행하기 어렵다
3. 스크립트를 유지보수하고 디버깅하기 어렵다

### 아티팩트 기반 빌드 시스템

엔지니어가 빌드할 대상들을 명시하여 명령줄에서 Blaze를 실행하면 Blaze는 나머지 컴파일 단계들을 설정, 실행, 스케줄링한다.  
어떤 도구를 언제 실행할지를 빌드 시스템이 통제하므로 정확성을 보장하면서도 훨씬 효율적으로 실행 가능하다.  
ex. Blaze, Bazel, Pants, Buck

#### 기능적 관점

아티팩트 기반 빌드 시스템과 함수형 프로그래밍은 비슷하다.  
- 함수형 프로그래밍 : 수행할 계산을 설명하지만, 그 계산을 정확히 언제 어떻게 수행할지는 컴파일러에게 맡긴다.
- 아티팩트 기반 빌드 시스템 : 매니페스트를 선언하고, 빌드를 어떻게 수행할지는 시스템에 맡긴다.

프로그래머 입장에서는 유연성이 줄어드는 대신 빌드의 각 단계에서 무슨 일이 이루어지는지를 빌드 시스템이 알게 된다.  
빌드 시스템은 이 지식을 활용해 빌드 프로세스를 병렬화하고 최대한 많은 것을 재사용하여 효율을 극대화시킨다.

### 분산 빌드

구글의 코드베이스 규모라면 아무리 좋은 컴퓨터라도 단 한대에만 빌드를 맡길 수 없다.  
분산 빌드란, 단위 작업들을 여러 컴퓨터에 뿌려 빌드한 후 취합해 최종 결과를 만들어주는 기술  
빌드 단위를 충분히 쪼갤 수 있다면 아무리 큰 빌드라도 원하는 시간 내에 끝마칠 수 있다.  
물론 그만한 비용은 하드웨어에 투자해야 한다.

#### 원격 캐싱

가장 간단한 분산 빌드는 원격 캐시만 이용하는 형태다.  
공유 캐시는 빠른 로컬 네트워크에 물려 있는 레디스일 수도 있고, 구글 클라우드 스토리지일 수도 있다.  
아티팩트를 다운로드하는 시간이 새로 빌드할 때보다 빨라야 원격 캐시가 의미가 있다.

#### 원격 실행

원격 실행은 빌드를 하는 실제 작업들을 워커에 나눠 수행하는 기술  
각 사용자의 컴퓨터에서 구동되는 빌드 도구가 중앙 빌드 마스터에 요청을 보내는 구조

## 18.4 모듈과 의존성 다루기

아티팩트 기반 빌드 시스템을 이용하는 프로젝트는 여러 개의 모듈로 나뉘며, 각 모듈은 다른 모듈과의 의존 관계를 BUILD 파일에 기술한다.  
이 모듈과 의존성을 어떻게 구성하느냐 -> 빌드 시스템의 성능과 감당할 수 있는 작업량 결정

- 작은 모듈 사용과 디렉터리 하나가 패키지, 타깃, BUILD 파일을 갖는 1:1:1 규칙
- 자신에게 의존할 수 있는 타깃의 범위를 지정하는 속성인 모듈 가시성 최소화
- 의존성 관리
