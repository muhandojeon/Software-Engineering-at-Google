# CHAPTER 9 코드 리뷰

## 9.1 코드 리뷰 흐름

1. **스냅샷** 만들기(현재 코드베이스와의 diff를 떠서 코드가 어떻게 달라졌는지 평가)
2. 셀프 리뷰가 만족스럽다면 한 명 이상의 리뷰어에게 **메일을 보내 리뷰 요청**
3. 리뷰어가 의견 남기기
4. 피드백 바탕으로 수정하고, 새로운 스냅샷 업로드해서 회신
5. 3-4단계 반복하다가 만족하면 리뷰어가 LGTM 태그 달아주기
6. LGTM 달리고 변경 승인되면 코드베이스에 커밋

## 9.2 코드 리뷰 @ 구글

구글에서는 승인을 얻으려면 3가지 측면에서의 리뷰를 통과해야 한다.  

1. **다른 엔지니어의 승인** : 팀원의 correctness, comprehension 평가
2. **코드 소유자의 승인** : 주로 테크 리드나 해당 영역의 기술 전문가의 평가
3. **가독성 승인** : 가독성 인증자의 평가

대부분의 리뷰는 세 역할을 모두 수행할 수 있는 한 명이 처리하기 때문에 이 절차가 빠르게 진행된다.  

> PR 올리면 자동으로 랜덤 리뷰어 3명 선정되고, approve 하나 받으면 머지하는 식으로 주로 작업하고 있어요  
> '첫 번째 LGTM이 가장 중요하며, 두 번째부터는 크게 신경 쓸 만큼의 가치가 없다'는 말에 공감이 되네요

## 9.3 코드 리뷰의 이점

구글은 코드 리뷰 프로세스를 타 회사들보다 더 철저하고 광범위하게 운영한다.  
구글은 엔지니어에게 폭넓은 자유를 허락하지만, 코드 리뷰만큼은 엔지니어 모두가 따라야 하는 몇 안 되는 전사적인 프로세스다.  
구글이 프로세스를 강제하는 까닭은 아래와 같다.  
- 코드 정확성
- 코드 이해 용이성
- 코드 일관성
- 심리적, 문화적 이점
- 지식 공유

## 9.4 코드 리뷰 모범 사례

- 공손하고 전문가답게
- 작게 변경하기(200줄 이하)
> 300줄 이하로 PR 올리는 규칙이 있는데 확실히 리뷰하기 편해요  
- 변경 설명 잘 쓰기
- 리뷰어는 최소한으로
- 가능한 한 자동화하기(ex. 정적 검사 자동화)

> AI 리뷰 잘 사용하시나요?  
> 전 선호하는데 이게 잘못된 리뷰를 남기기도 하고 한 번에 코멘트 몇십 개 남기는 경우도 있어서 별로라고 느끼는 분들도 있더라구요
> 
> [bedrock-pr-reviewer](https://github.com/tmokmss/bedrock-pr-reviewer)  
> Tip: You can change the bot personality by configuring the system_message value.
> 
> [Copilot 리뷰](https://github.blog/changelog/2024-10-29-github-copilot-code-review-in-github-com-private-preview)
> 
> 구글은 자체 개발한 코드 리뷰 도구 [Critique](https://abseil.io/resources/swe-book/html/ch19.html)을 이용한다는데, 여기에 AI 기능이 생겼을지도 궁금하네요  

## 9.5 코드 리뷰 유형

- 그린필드 코드 리뷰
  - 새로운 기능에 해당
  - 초기에 내린 가정들이 변해도 여전히 유지보수하기 쉬운 코드여야 한다.
  - 코드가 지속 가능함을 보장하기 위해 설계에 부합하고 테스트도 완벽하게 이루어졌는지 확인해야 한다.
- 동작 변경, 개선, 최적화
  - 기존 코드 수정에 해당
  - 꼭 필요한 변경인지, 코드베이스를 개선하는지 살펴야 한다.
  - 죽은 코드 제거
  - 동작 수정 시 테스트도 함께 수정
- 버그 수정과 롤백
  - 버그를 수정하면서 다른 문제도 묶어서 처리하면 안 된다.
  - 버그 수정 시 테스트 보강
  - 잠재적으로 롤백을 유발할 수 있는 모든 변경은 가능한 한 작고 원자적이어야 한다.
- 리팩터링과 대규모 변경
  - 기계가 대규모 변경을 자동으로 생성하기도 한다.
  - 기계가 생성한 변경도 리뷰가 필요하다.
  - 자동 생성된 변경이라도 정확성과 적용 가능성을 확인한다. 
